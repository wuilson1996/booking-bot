{% extends 'layouts/base.html' %}
{% block title %} Dashboard {% endblock title %}
{% load static %}
<!-- Specific CSS goes HERE -->
{% block stylesheets %}
{% endblock stylesheets %}

{% block content %}
<style>
  .tooltip .tooltip-inner{
    max-width: 500px !important;
    width: 400px !important;
  }
</style>

<div class="m-4 row">
    <div class="col-12">
      <div class="card">
        <!-- Card header -->
        <div class="pb-0 card-header">
          <div class="d-lg-flex">
            <div>
              <h5 class="mb-0">Historico de precio de zona</br>
              {{day}} / {{date}}</h5>
              <p class="mb-0 text-sm">
               
              </p>
            </div>
          </div>
        </div>
        <div class="px-0 pb-0 card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="row mt-4 h-30">
                        <div class="col-md-12">
                            <div class="card z-index-2">
                                <div class="card-header p-3 pb-0">
                                    <div class="table-responsive">
                                        <table class="table table-flush table-sm" id="client-list">
                                            <thead class="thead-light">
                                                <tr>
                                                <th class="text-xs">Hotel</th>
                                                <th class="text-xs">Actual</th>
                                                <th class="text-xs">D1</th>
                                                <th class="text-xs">D2</th>
                                                <th class="text-xs">D3</th>
                                                <th class="text-xs">D4</th>
                                                <th class="text-xs">D5</th>
                                                <th class="text-xs">D6</th>
                                                <th class="text-xs">D7</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for value in history_hotel %}
                                                
                                                <tr class="tr">
                                                    <!-- <td class="text-sm bg-success text-white">{{request.GET.date}}</td> -->
                                                    <td class="text-sm {{bg_color}}">{{value.name}}</td>
                                                    {% for price in value.price %}
                                                    <td class="text-sm {{bg_color}}">{{price}}</td>
                                                    {% endfor %}
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                            <!-- <tfoot>
                                                <tr>
                                                    <th>Hotel</th>
                                                    <th>Actual</th>
                                                    <th>1</th>
                                                    <th>2</th>
                                                    <th>3</th>
                                                    <th>4</th>
                                                    <th>5</th>
                                                    <th>6</th>
                                                    <th>7</th>
                                                </tr>
                                            </tfoot> -->
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="row mt-4 h-30">
                        <div class="col-md-12">
                        <div class="card z-index-2">
                            <div class="card-header p-3 pb-0">
                            <h6></h6>
                            </div>
                            <div class="card-body p-3">
                            <div class="chart">
                                <canvas id="lineStad" class="chart-canvas" height="400"></canvas>
                            </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>

{% include 'includes/scripts.html' %}

<script>
    var historyHotel = textToJson('{{history_hotel_text}}');
    console.log(historyHotel);
    // if (document.getElementById('client-list')) {
    //   const dataTableSearch = new simpleDatatables.DataTable("#client-list", {
    //     searchable: true,
    //     fixedHeight: false,
    //     perPage: 13
    //   });

    //   document.querySelectorAll(".export").forEach(function(el) {
    //     el.addEventListener("click", function(e) {
    //       var type = el.dataset.type;

    //       var data = {
    //         type: type,
    //         filename: "soft-ui-" + type,
    //       };

    //       if (type === "csv") {
    //         data.columnDelimiter = "|";
    //       }

    //       dataTableSearch.export(data);
    //     });
    //   });
    // };
    // function activeAlert(pk_user){
    //     Swal.fire({
    //     title: 'Eliminar Usuario?',
    //     text: "!Esta seguro de eliminar este usuario!",
    //     icon: 'warning',
    //     showCancelButton: true,
    //     confirmButtonColor: '#3085d6',
    //     cancelButtonColor: '#d33',
    //     confirmButtonText: 'si, Eliminar!',
    //     cancelButtonText: 'Cancelar'
    //   }).then((result) => {
    //     if (result.isConfirmed){
    //       window.location.href = "/delete-user?pk="+pk_user;
    //     }
    //   })
    // }

const ctx1 = document.getElementById("lineStad").getContext("2d");

// Crear gradientes para el gráfico
var gradientStroke = ctx1.createLinearGradient(0, 230, 0, 50);
gradientStroke.addColorStop(1, 'rgba(94, 114, 228, 0.2)');
gradientStroke.addColorStop(0.2, 'rgba(72,72,176,0.0)');
gradientStroke.addColorStop(0, 'rgba(94, 114, 228,0)');

var gradientStroke2 = ctx1.createLinearGradient(0, 230, 0, 50);
gradientStroke2.addColorStop(1, 'rgba(20,23,39,0.2)');
gradientStroke2.addColorStop(0.2, 'rgba(72,72,176,0.0)');
gradientStroke2.addColorStop(0, 'rgba(20,23,39,0)');

// Eje X
const labels = ["Dia 7", "Dia 6", "Dia 5", "Dia 4", "Dia 3", "Dia 2", "Dia 1", "Actual"];

// Generar datasets por hotel
let dataSets = [];
let dayTotals = Array(8).fill(0); // Para la media

historyHotel.forEach((hotel, index) => {
  const prices = hotel.price.map(p => parseFloat(p)).slice().reverse();
  
  // Sumar para promedio
  for (let i = 0; i < prices.length; i++) {
    dayTotals[i] += prices[i];
  }

  const dataset = {
    label: hotel.code,
    tension: 0.4,
    borderWidth: 0,
    pointRadius: 2,
    pointBackgroundColor: hotel.code === "SF" ? "#2dce89" : "#6c757d",
    borderColor: hotel.code === "SF" ? "#2dce89" : "#6c757d",
    borderWidth: 3,
    backgroundColor: hotel.code === "SF" ? gradientStroke : gradientStroke2,
    data: prices,
    maxBarThickness: 6,
    hidden: false//hotel.code !== "SF" && index > 5 // muestra los 6 primeros + SF
  };

  dataSets.push(dataset);
});

// Dataset adicional para el promedio
let avgData = dayTotals.map(total => Math.round(total / historyHotel.length));

dataSets.unshift({
  label: "Media",
  tension: 0.4,
  borderWidth: 0,
  pointRadius: 2,
  pointBackgroundColor: "#5e72e4",
  borderColor: "#5e72e4",
  borderWidth: 3,
  backgroundColor: gradientStroke,
  data: avgData,
  maxBarThickness: 6
});

// Crear el gráfico
new Chart(ctx1, {
  type: "line",
  data: {
    labels: labels,
    datasets: dataSets
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        display: true,
        position: 'top',
        align: 'end',
        labels: {
          boxWidth: 6,
          boxHeight: 6,
          padding: 20,
          pointStyle: 'circle',
          borderRadius: 50,
          usePointStyle: true,
          font: {
            weight: 600,
          },
        },
      }
    },
    interaction: {
      intersect: false,
      mode: 'index',
    },
    scales: {
      y: {
        grid: {
          drawBorder: false,
          display: true,
          drawOnChartArea: true,
          drawTicks: false,
          borderDash: [5, 5]
        },
        ticks: {
          display: true,
          padding: 10,
          color: '#b2b9bf',
          font: {
            size: 11,
            family: "Open Sans",
            style: 'normal',
            lineHeight: 2
          },
        }
      },
      x: {
        grid: {
          drawBorder: false,
          display: true,
          drawOnChartArea: true,
          drawTicks: true,
          borderDash: [5, 5]
        },
        ticks: {
          display: true,
          color: '#b2b9bf',
          padding: 10,
          font: {
            size: 11,
            family: "Open Sans",
            style: 'normal',
            lineHeight: 2
          },
        }
      },
    },
  }
});

  </script>


{% endblock content %}
  
<!-- Specific JS goes HERE --> 
{% block javascripts %}

{% endblock javascripts %}